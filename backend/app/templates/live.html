<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>North Star Live</title>
  <style>
    body { font-family: system-ui; margin: 20px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; width:340px; }
    .score { font-size:26px; font-weight:700; }
    .pill { display:inline-block; padding:3px 8px; border-radius:999px; background:#f2f2f2; margin-right:6px; font-size:12px; }
    .muted { color:#666; font-size:12px; }
    button { padding:8px 10px; border-radius:10px; border:1px solid #ccc; background:white; cursor:pointer; }
    input { padding:8px; border-radius:10px; border:1px solid #ccc; width:420px; }
  </style>
</head>
<body>
  <h2>üõ∞Ô∏è North Star Live Threat Feed</h2>

  <div style="margin: 10px 0 18px 0;">
    <input id="url" placeholder="https://example.com" />
    <button onclick="scanUrl()">Scan URL</button>
    <span class="muted" id="status"></span>
  </div>

  <div class="row" id="cards"></div>

<script>
const cards = document.getElementById("cards");
const statusEl = document.getElementById("status");

function cardHTML(a) {
  return `
  <div class="card">
    <div class="score">${Number(a.score).toFixed(1)}</div>
    <div style="margin:6px 0;">
      <span class="pill">${a.category}</span>
      <span class="pill">${a.sector}</span>
      <span class="pill">${a.intent}</span>
    </div>
    <div><b>${a.title || "(no title)"}</b></div>
    <div class="muted">${a.source || ""} ${a.url || ""}</div>
    <div class="muted">#${a.id} ‚Ä¢ ${a.created_at}</div>
  </div>`;
}

function pushCard(a) {
  const div = document.createElement("div");
  div.innerHTML = cardHTML(a);
  cards.prepend(div.firstElementChild);
}

async function scanUrl() {
  const u = document.getElementById("url").value.trim();
  if (!u) return;
  statusEl.textContent = "scanning‚Ä¶";
  const r = await fetch("/scan/url", {
    method: "POST",
    headers: {"Content-Type":"application/json", "x-api-key":"dev"},
    body: JSON.stringify({url: u})
  });
  const j = await r.json();
  statusEl.textContent = j.ok
    ? `stored post_id=${j.post_id} alert_id=${j.alert_id}`
    : `failed: ${(j.fetch && j.fetch.error) ? j.fetch.error : (j.error || "unknown")}`;
}

// SSE
const es = new EventSource("/alerts/stream");
es.addEventListener("hello", () => console.log("connected"));
es.addEventListener("alert", (ev) => {
  const a = JSON.parse(ev.data);
  pushCard(a);
});
</script>
</body>
</html>
